<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker 用量看板</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { --primary: #F38020; --bg: #f9fafb; --card-bg: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* 顶部标题栏 */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { font-size: 20px; margin: 0; display: flex; align-items: center; gap: 10px; }
        .update-time { font-size: 12px; color: #666; background: #eee; padding: 4px 8px; border-radius: 4px; }

        /* 卡片布局 - 模仿 Cloudflare 红框区域 */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; }
        .card-title { font-size: 14px; color: #6b7280; margin-bottom: 8px; font-weight: 500; }
        .card-value { font-size: 28px; font-weight: 700; color: #111827; }
        .card-sub { font-size: 12px; color: #9ca3af; margin-top: 4px; }
        
        /* 图表区域 */
        .chart-container { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; height: 400px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span style="color:var(--primary)">☁️</span> Worker 用量看板</h1>
            <span id="update-time" class="update-time">更新中...</span>
        </div>

        <div class="stats-grid">
            <div class="card">
                <div class="card-title">总请求数 (30天)</div>
                <div class="card-value" id="total-requests">-</div>
                <div class="card-sub">Total Requests</div>
            </div>
            <div class="card">
                <div class="card-title">错误请求数</div>
                <div class="card-value" id="total-errors" style="color: #ef4444">-</div>
                <div class="card-sub">Errors</div>
            </div>
            <div class="card">
                <div class="card-title">请求成功率</div>
                <div class="card-value" id="success-rate">-</div>
                <div class="card-sub">Success Rate</div>
            </div>
        </div>

        <div id="main" class="chart-container"></div>
    </div>

    <script>
        fetch('./data.json')
            .then(res => res.json())
            .then(data => {
                // 1. 数据处理：聚合统计
                let totalReq = 0;
                let totalErr = 0;
                
                // 按日期归并数据（处理多个 Worker 的情况）
                const dateMap = {};
                
                data.forEach(item => {
                    totalReq += item.sum.requests;
                    totalErr += item.sum.errors;
                    
                    // 提取日期（去除时间部分）
                    const dateStr = item.dimensions.datetime.split('T')[0];
                    if (!dateMap[dateStr]) {
                        dateMap[dateStr] = { requests: 0, errors: 0 };
                    }
                    dateMap[dateStr].requests += item.sum.requests;
                    dateMap[dateStr].errors += item.sum.errors;
                });

                // 2. 更新顶部卡片数字
                document.getElementById('total-requests').innerText = totalReq.toLocaleString();
                document.getElementById('total-errors').innerText = totalErr.toLocaleString();
                
                const rate = totalReq > 0 ? ((totalReq - totalErr) / totalReq * 100).toFixed(2) + '%' : '0%';
                document.getElementById('success-rate').innerText = rate;
                document.getElementById('update-time').innerText = '最后更新: ' + new Date().toLocaleString();

                // 3. 准备图表数据
                const sortedDates = Object.keys(dateMap).sort();
                const seriesReq = sortedDates.map(d => dateMap[d].requests);
                const seriesErr = sortedDates.map(d => dateMap[d].errors);

                // 4. 渲染图表
                const chart = echarts.init(document.getElementById('main'));
                chart.setOption({
                    title: { text: '每日请求趋势', left: 'center', textStyle: { fontSize: 14, color: '#666' } },
                    tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                    legend: { bottom: 0, data: ['请求数', '错误数'] },
                    grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                    xAxis: { 
                        type: 'category', 
                        data: sortedDates,
                        axisLine: { lineStyle: { color: '#e5e7eb' } },
                        axisLabel: { color: '#6b7280' }
                    },
                    yAxis: { 
                        type: 'value', 
                        splitLine: { lineStyle: { type: 'dashed', color: '#f3f4f6' } } 
                    },
                    series: [
                        {
                            name: '请求数',
                            type: 'line',
                            data: seriesReq,
                            smooth: true,
                            symbol: 'none',
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(243, 128, 32, 0.3)' },
                                    { offset: 1, color: 'rgba(243, 128, 32, 0.01)' }
                                ])
                            },
                            itemStyle: { color: '#F38020' }
                        },
                        {
                            name: '错误数',
                            type: 'bar',
                            data: seriesErr,
                            itemStyle: { color: '#ef4444' }
                        }
                    ]
                });
                
                // 响应式调整
                window.addEventListener('resize', () => chart.resize());
            })
            .catch(err => {
                console.error(err);
                document.getElementById('update-time').innerText = '数据加载失败，请检查 Actions 日志';
            });
    </script>
</body>
</html>
