<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker ç›‘æ§é¢æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { --primary: #F38020; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 10px; }
        .header h1 { margin: 0; font-size: 24px; display: flex; align-items: center; gap: 8px; }
        
        .last-update { font-size: 13px; color: #6b7280; background: #e5e7eb; padding: 6px 12px; border-radius: 20px; }

        .quota-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; border-left: 5px solid var(--primary); }
        .quota-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; font-size: 16px; }
        .progress-bg { height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #F38020, #f9a056); width: 0%; transition: width 1s ease; border-radius: 10px; }
        .quota-text { display: flex; justify-content: space-between; font-size: 13px; color: #6b7280; margin-top: 6px; }

        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { border: none; background: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; color: #666; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn.active { background: var(--primary); color: white; font-weight: 500; }
        .btn:hover:not(.active) { background: #f9fafb; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .stat-title { color: #6b7280; font-size: 13px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 28px; font-weight: 700; color: #111827; }
        .text-green { color: #10b981; } .text-red { color: #ef4444; }

        #chart-container { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 450px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span style="color:var(--primary)">âš¡</span> Cloudflare Worker ç›‘æ§</h1>
            <span id="update-time" class="last-update">è½½å…¥ä¸­...</span>
        </div>

        <div class="quota-card">
            <div class="quota-header">
                <span>ä»Šæ—¥è¯·æ±‚ç”¨é‡ (UTC)</span>
                <span id="quota-percent">0%</span>
            </div>
            <div class="progress-bg">
                <div id="quota-bar" class="progress-bar"></div>
            </div>
            <div class="quota-text">
                <span id="quota-detail">0 / 100,000</span>
                <span>é‡ç½®æ—¶é—´: 00:00 UTC</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn active" onclick="setRange('24h')">æœ€è¿‘ 24 å°æ—¶</button>
            <button class="btn" onclick="setRange('7d')">æœ€è¿‘ 7 å¤©</button>
            <button class="btn" onclick="setRange('30d')">æœ€è¿‘ 30 å¤©</button>
        </div>

        <div class="grid">
            <div class="stat-card">
                <div class="stat-title">åŒºé—´æ€»è¯·æ±‚æ•°</div>
                <div class="stat-value" id="disp-req">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">åŒºé—´é”™è¯¯æ•°</div>
                <div class="stat-value text-red" id="disp-err">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">å¹³å‡æ¯å°æ—¶è¯·æ±‚</div>
                <div class="stat-value" id="disp-avg">-</div>
            </div>
        </div>

        <div id="chart-container"></div>
    </div>

    <script>
        let rawData = [];
        let chartInstance = null;
        let currentRange = '24h';
        const DAILY_LIMIT = 100000;

        function init() {
            refreshData();
        }

        function refreshData() {
            fetch('./data.json?t=' + new Date().getTime())
                .then(res => {
                    if (!res.ok) throw new Error("HTTP " + res.status);
                    return res.json();
                })
                .then(jsonResponse => {
                    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ä¿®æ”¹ç‚¹ï¼šé€‚é…æ–°çš„æ•°æ®ç»“æ„ ğŸ‘‡ğŸ‘‡ğŸ‘‡
                    // 1. å¦‚æœæ˜¯æ—§æ ¼å¼(æ•°ç»„)ï¼Œç›´æ¥ç”¨ï¼›å¦‚æœæ˜¯æ–°æ ¼å¼(å¯¹è±¡)ï¼Œå– .data
                    rawData = Array.isArray(jsonResponse) ? jsonResponse : jsonResponse.data;
                    
                    // 2. å¤„ç†æ—¶é—´æ˜¾ç¤º
                    if (jsonResponse.updatedAt) {
                        const serverTime = new Date(jsonResponse.updatedAt);
                        document.getElementById('update-time').innerText = 'æ•°æ®æ›´æ–°äº: ' + serverTime.toLocaleString();
                    } else {
                        // å…¼å®¹æ—§æ•°æ®ï¼Œæ²¡æœ‰æ—¶é—´æˆ³æ—¶æ˜¾ç¤ºå½“å‰æ—¶é—´
                        document.getElementById('update-time').innerText = 'æœ€ååŒæ­¥: ' + new Date().toLocaleString();
                    }
                    // ğŸ‘†ğŸ‘†ğŸ‘† ä¿®æ”¹ç‚¹ç»“æŸ ğŸ‘†ğŸ‘†ğŸ‘†

                    try {
                        calculateTodayQuota();
                        setRange(currentRange); 
                    } catch (e) {
                        console.error("Render error:", e);
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('update-time').innerText = 'æ•°æ®åŒæ­¥å¤±è´¥';
                });
        }

        function calculateTodayQuota() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todayRequests = rawData
                .filter(item => item.dimensions.datetime.startsWith(todayStr))
                .reduce((sum, item) => sum + item.sum.requests, 0);

            const percent = Math.min((todayRequests / DAILY_LIMIT) * 100, 100).toFixed(1);
            document.getElementById('quota-bar').style.width = percent + '%';
            document.getElementById('quota-percent').innerText = percent + '%';
            document.getElementById('quota-detail').innerText = `${todayRequests.toLocaleString()} / ${DAILY_LIMIT.toLocaleString()}`;
            
            if (percent > 80) document.getElementById('quota-bar').style.backgroundColor = '#ef4444';
        }

        function setRange(range) {
            currentRange = range;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            
            const btns = document.querySelectorAll('.btn');
            if(range === '24h') btns[0].classList.add('active');
            if(range === '7d') btns[1].classList.add('active');
            if(range === '30d') btns[2].classList.add('active');

            const now = new Date();
            let startTime = new Date();
            
            if (range === '24h') startTime.setTime(now.getTime() - 24 * 60 * 60 * 1000);
            else if (range === '7d') startTime.setDate(now.getDate() - 7);
            else startTime.setDate(now.getDate() - 30);

            const filtered = rawData.filter(item => new Date(item.dimensions.datetime) >= startTime);

            const map = {};
            filtered.forEach(item => {
                const d = new Date(item.dimensions.datetime);
                let key;
                if (range === '24h') {
                    key = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:00`;
                } else {
                    key = d.toISOString().split('T')[0];
                }

                if (!map[key]) map[key] = { req: 0, err: 0 };
                map[key].req += item.sum.requests;
                map[key].err += item.sum.errors;
            });

            const sortedKeys = Object.keys(map).sort((a, b) => {
               if (range === '24h') {
                   const parseTime = (str) => {
                       const [datePart, timePart] = str.split(' ');
                       const [m, d] = datePart.split('/');
                       const [h] = timePart.split(':');
                       const year = new Date().getFullYear(); 
                       return new Date(year, m-1, d, h).getTime();
                   };
                   return parseTime(a) - parseTime(b);
               }
               return a.localeCompare(b);
            });

            const requests = sortedKeys.map(k => map[k].req);
            const errors = sortedKeys.map(k => map[k].err);

            const totalReq = requests.reduce((a, b) => a + b, 0);
            const totalErr = errors.reduce((a, b) => a + b, 0);
            document.getElementById('disp-req').innerText = totalReq.toLocaleString();
            document.getElementById('disp-err').innerText = totalErr.toLocaleString();
            
            const avg = sortedKeys.length > 0 ? Math.round(totalReq / sortedKeys.length) : 0;
            document.getElementById('disp-avg').innerText = avg.toLocaleString();

            renderChart(sortedKeys, requests, errors, range);
        }

        function renderChart(labels, reqData, errData, range) {
            if (chartInstance) chartInstance.dispose();
            chartInstance = echarts.init(document.getElementById('chart-container'));

            const option = {
                title: { text: 'è¯·æ±‚è¶‹åŠ¿', left: 'center' },
                tooltip: { 
                    trigger: 'axis', 
                    axisPointer: { type: 'cross' },
                    valueFormatter: (value) => Math.floor(value) 
                },
                legend: { data: ['æ€»è¯·æ±‚', 'é”™è¯¯'], bottom: 0 },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: labels,
                    axisLabel: { 
                        interval: range === '30d' ? 2 : 'auto', 
                        rotate: range === '24h' ? 45 : 0 
                    }
                },
                yAxis: { 
                    type: 'value',
                    minInterval: 1,
                    axisLabel: { formatter: (value) => Math.floor(value) },
                    axisPointer: {
                        label: {
                            formatter: function(params) {
                                return Math.floor(params.value);
                            }
                        }
                    }
                },
                series: [
                    {
                        name: 'æ€»è¯·æ±‚',
                        type: 'line',
                        smooth: true,
                        data: reqData,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(243, 128, 32, 0.4)' },
                                { offset: 1, color: 'rgba(243, 128, 32, 0.05)' }
                            ])
                        },
                        itemStyle: { color: '#F38020' }
                    },
                    {
                        name: 'é”™è¯¯',
                        type: 'bar',
                        data: errData,
                        itemStyle: { color: '#ef4444' }
                    }
                ]
            };
            chartInstance.setOption(option);
            window.onresize = chartInstance.resize;
        }

        init();
    </script>
</body>
</html>
