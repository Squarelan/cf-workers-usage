<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Worker ç›‘æ§é¢æ¿</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%E2%9A%A1%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

  <style>
    :root { --primary: #F38020; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 10px; }
    .header h1 { margin: 0; font-size: 24px; display: flex; align-items: center; gap: 8px; }

    .last-update { font-size: 13px; color: #6b7280; background: #e5e7eb; padding: 6px 12px; border-radius: 20px; }

    .quota-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; border-left: 5px solid var(--primary); }
    .quota-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; font-size: 16px; }
    .progress-bg { height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; position: relative; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #F38020, #f9a056); width: 0%; transition: width 1s ease; border-radius: 10px; }
    .quota-text { display: flex; justify-content: space-between; font-size: 13px; color: #6b7280; margin-top: 6px; }

    .controls { display: flex; gap: 10px; margin-bottom: 15px; }
    .btn { border: none; background: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; color: #666; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .btn.active { background: var(--primary); color: white; font-weight: 500; }
    .btn:hover:not(.active) { background: #f9fafb; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .stat-title { color: #6b7280; font-size: 13px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 28px; font-weight: 700; color: #111827; }
    .text-green { color: #10b981; } .text-red { color: #ef4444; }

    #chart-container { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 450px; }

    /* =========================
       ä¸»é¢˜åˆ‡æ¢ï¼ˆæ–°å¢ï¼‰
       ========================= */
    html[data-theme="dark"] {
      --bg: #0b1220;
      --card: #0f172a;
      --text: #e5e7eb;
    }

    html[data-theme="dark"] .last-update { background: rgba(255,255,255,0.08); color: #cbd5e1; }
    html[data-theme="dark"] .btn { background: rgba(255,255,255,0.06); color: #cbd5e1; }
    html[data-theme="dark"] .btn:hover:not(.active) { background: rgba(255,255,255,0.10); }
    html[data-theme="dark"] .progress-bg { background: rgba(255,255,255,0.10); }
    html[data-theme="dark"] .stat-title { color: #94a3b8; }
    html[data-theme="dark"] .stat-value { color: #f1f5f9; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .icon-btn {
      width: 40px;
      height: 36px;
      border: none;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.12s ease, background 0.2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .icon-btn:hover { transform: translateY(-1px); }
    .icon-btn:active { transform: translateY(0); }

    html[data-theme="dark"] .icon-btn { background: rgba(255,255,255,0.06); }

    .icon {
      font-size: 18px;
      line-height: 1;
      display: inline-block;
      transform-origin: 50% 50%;
      transition: transform 280ms ease;
    }

    /* ç‚¹å‡»æ—¶çš„æ—‹è½¬åŠ¨ç”»ï¼ˆæ–°å¢ï¼‰ */
    .icon.spin {
      transform: rotate(180deg);
    }

    /* ===== æµ…è‰²æ¨¡å¼ï¼šåŒºé—´æŒ‰é’®å±‚çº§æ›´æ¸…æ™° ===== */
    .controls .btn{
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #374151;
    }

    .controls .btn:hover:not(.active){
      background: #f9fafb;
      border-color: #d1d5db;
    }

    /* é€‰ä¸­æ€ï¼šæ©™è‰² + è½»å¾®æŠ•å½± */
    .controls .btn.active{
      background: var(--primary);
      border-color: var(--primary);
      color: #ffffff;
      font-weight: 700;
      box-shadow: 0 4px 10px rgba(243,128,32,0.30);
    }

    /* âœ… æ·±è‰²æ¨¡å¼ä¸‹ï¼šæŒ‰é’®æ›´å¥½åŒºåˆ†é€‰ä¸­æ€ */
    html[data-theme="dark"] .controls .btn{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      color: #cbd5e1;
    }

    html[data-theme="dark"] .controls .btn:hover:not(.active){
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.18);
    }

    /* é€‰ä¸­æ€ï¼šæ›´äº® + è¾¹æ¡†æ›´æ˜æ˜¾ + å‘å…‰ä¸€ç‚¹ */
    html[data-theme="dark"] .controls .btn.active{
      background: var(--primary);
      border-color: rgba(255,255,255,0.22);
      color: #0b1220;                 /* è®©å­—æ›´æ¸…æ™° */
      font-weight: 700;
      box-shadow: 0 0 0 3px rgba(243,128,32,0.25);
    }

    /* âœ… æ·±è‰²æ¨¡å¼ä¸‹ä¹Ÿè¦ä¿æŒçº¢/ç»¿è¯­ä¹‰è‰² */
    html[data-theme="dark"] .stat-value.text-red { color: #ef4444 !important; }
    html[data-theme="dark"] .stat-value.text-green { color: #10b981 !important; }

    /* âœ… å¯é€‰ä¼˜åŒ–ï¼šä¸»é¢˜åˆ‡æ¢æ›´ä¸æ»‘ï¼ˆæ–°å¢ï¼‰ */
    body, .quota-card, .stat-card, #chart-container, .last-update, .btn, .icon-btn {
      transition: background-color 200ms ease, color 200ms ease, border-color 200ms ease, box-shadow 200ms ease;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1><span style="color:var(--primary)">âš¡</span> Cloudflare Worker ç›‘æ§</h1>

      <div class="header-right">
        <button id="theme-toggle" class="icon-btn" type="button" aria-label="åˆ‡æ¢ä¸»é¢˜" title="åˆ‡æ¢ä¸»é¢˜">
          <span id="theme-icon" class="icon" aria-hidden="true">ğŸŒ™</span>
        </button>
        <span id="update-time" class="last-update">è½½å…¥ä¸­...</span>
      </div>
    </div>

    <div class="quota-card">
      <div class="quota-header">
        <span>ä»Šæ—¥è¯·æ±‚ç”¨é‡ (UTC)</span>
        <span id="quota-percent">0%</span>
      </div>
      <div class="progress-bg">
        <div id="quota-bar" class="progress-bar"></div>
      </div>
      <div class="quota-text">
        <span id="quota-detail">0 / 100,000</span>
        <span>é‡ç½®æ—¶é—´: 00:00 UTC</span>
      </div>
    </div>

    <div class="controls">
      <!-- âœ… å»ºè®®ä¿®æ”¹ï¼šåŠ  data-rangeï¼ŒsetRange ä¼šç²¾ç¡®åŒ¹é…æŒ‰é’® -->
      <button class="btn active" data-range="24h" onclick="setRange('24h')">æœ€è¿‘ 24 å°æ—¶</button>
      <button class="btn" data-range="7d" onclick="setRange('7d')">æœ€è¿‘ 7 å¤©</button>
      <button class="btn" data-range="30d" onclick="setRange('30d')">æœ€è¿‘ 30 å¤©</button>
    </div>

    <div class="grid">
      <div class="stat-card">
        <div class="stat-title">åŒºé—´æ€»è¯·æ±‚æ•°</div>
        <div class="stat-value" id="disp-req">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">åŒºé—´é”™è¯¯æ•°</div>
        <div class="stat-value text-red" id="disp-err">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">å¹³å‡æ¯å°æ—¶è¯·æ±‚</div>
        <div class="stat-value" id="disp-avg">-</div>
      </div>
    </div>

    <div id="chart-container"></div>
  </div>

  <script>
    let rawData = [];
    let chartInstance = null;
    let currentRange = '24h';
    const DAILY_LIMIT = 100000;

    // ================
    // ä¸»é¢˜åˆ‡æ¢
    // ================
    let theme = 'light';

    function initTheme() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      theme = saved || (prefersDark ? 'dark' : 'light');

      applyTheme(theme);

      const btn = document.getElementById('theme-toggle');
      const icon = document.getElementById('theme-icon');

      btn.addEventListener('click', () => {
        // icon æ—‹è½¬ä¸€ä¸‹
        icon.classList.add('spin');
        window.setTimeout(() => icon.classList.remove('spin'), 300);

        theme = (theme === 'dark') ? 'light' : 'dark';
        localStorage.setItem('theme', theme);
        applyTheme(theme);

        // ä¸»é¢˜åˆ‡æ¢åé‡ç»˜å›¾è¡¨ï¼Œé€‚é…æ–‡å­—/èƒŒæ™¯
        setRange(currentRange);
      });
    }

    function applyTheme(t) {
      document.documentElement.setAttribute('data-theme', t);
      const icon = document.getElementById('theme-icon');
      const btn = document.getElementById('theme-toggle');
      icon.textContent = (t === 'dark') ? 'â˜€ï¸' : 'ğŸŒ™';
      btn.title = (t === 'dark') ? 'å½“å‰ï¼šæ·±è‰²ï¼ˆç‚¹å‡»åˆ‡æ¢ï¼‰' : 'å½“å‰ï¼šæµ…è‰²ï¼ˆç‚¹å‡»åˆ‡æ¢ï¼‰';
    }

    function init() {
      initTheme();
      refreshData();
    }

    function refreshData() {
      fetch('./data.json?t=' + new Date().getTime())
        .then(res => {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(jsonResponse => {
          rawData = Array.isArray(jsonResponse) ? jsonResponse : (jsonResponse.data || []);

          if (jsonResponse.updatedAt) {
            const serverTime = new Date(jsonResponse.updatedAt);
            document.getElementById('update-time').innerText = 'æ•°æ®æ›´æ–°äº: ' + serverTime.toLocaleString();
          } else {
            document.getElementById('update-time').innerText = 'æœ€ååŒæ­¥: ' + new Date().toLocaleString();
          }

          try {
            calculateTodayQuota();
            setRange(currentRange);
          } catch (e) {
            console.error("Render error:", e);
          }
        })
        .catch(err => {
          console.error(err);
          document.getElementById('update-time').innerText = 'æ•°æ®åŒæ­¥å¤±è´¥';
        });
    }

    function calculateTodayQuota() {
      const todayStr = new Date().toISOString().split('T')[0];
      const todayRequests = rawData
        .filter(item => item.dimensions.datetime.startsWith(todayStr))
        .reduce((sum, item) => sum + item.sum.requests, 0);

      const percent = Math.min((todayRequests / DAILY_LIMIT) * 100, 100).toFixed(1);
      const bar = document.getElementById('quota-bar');

      bar.style.width = percent + '%';
      document.getElementById('quota-percent').innerText = percent + '%';
      document.getElementById('quota-detail').innerText = `${todayRequests.toLocaleString()} / ${DAILY_LIMIT.toLocaleString()}`;

      // âœ… å¯é€‰ä¼˜åŒ–ï¼šè¶…è¿‡ 80% å˜çº¢ï¼Œå¹¶åŒæ­¥å·¦è¾¹æ¡†ï¼ˆæ–°å¢ï¼‰
      const card = document.querySelector('.quota-card');
      if (percent > 80) {
        bar.style.background = '#ef4444';
        card.style.borderLeftColor = '#ef4444';
      } else {
        bar.style.background = 'linear-gradient(90deg, #F38020, #f9a056)';
        card.style.borderLeftColor = 'var(--primary)';
      }
    }

    function setRange(range) {
      currentRange = range;

      // âœ… å»ºè®®ä¿®æ”¹ï¼šæŒ‰ data-range ç²¾ç¡®åŒ¹é… active æŒ‰é’®ï¼ˆæ–°å¢ï¼‰
      document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
      const activeBtn = document.querySelector(`.btn[data-range="${range}"]`);
      if (activeBtn) activeBtn.classList.add('active');

      const now = new Date();
      let startTime = new Date();

      if (range === '24h') startTime.setTime(now.getTime() - 24 * 60 * 60 * 1000);
      else if (range === '7d') startTime.setDate(now.getDate() - 7);
      else startTime.setDate(now.getDate() - 30);

      const filtered = rawData.filter(item => new Date(item.dimensions.datetime) >= startTime);

      const map = {};
      filtered.forEach(item => {
        const d = new Date(item.dimensions.datetime);
        let key;

        if (range === '24h') key = `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:00`;
        else key = d.toISOString().split('T')[0];

        if (!map[key]) map[key] = { req: 0, err: 0 };
        map[key].req += item.sum.requests;
        map[key].err += item.sum.errors;
      });

      const sortedKeys = Object.keys(map).sort((a, b) => {
        if (range === '24h') {
          const parseTime = (str) => {
            const [datePart, timePart] = str.split(' ');
            const [m, d] = datePart.split('/');
            const [h] = timePart.split(':');
            const year = new Date().getFullYear();
            return new Date(year, m - 1, d, h).getTime();
          };
          return parseTime(a) - parseTime(b);
        }
        return a.localeCompare(b);
      });

      const requests = sortedKeys.map(k => map[k].req);
      const errors = sortedKeys.map(k => map[k].err);

      const totalReq = requests.reduce((a, b) => a + b, 0);
      const totalErr = errors.reduce((a, b) => a + b, 0);

      document.getElementById('disp-req').innerText = totalReq.toLocaleString();
      document.getElementById('disp-err').innerText = totalErr.toLocaleString();

      const avg = sortedKeys.length > 0 ? Math.round(totalReq / sortedKeys.length) : 0;
      document.getElementById('disp-avg').innerText = avg.toLocaleString();

      renderChart(sortedKeys, requests, errors, range);
    }

    function renderChart(labels, reqData, errData, range) {
      if (chartInstance) chartInstance.dispose();
      chartInstance = echarts.init(document.getElementById('chart-container'));

      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const axisText = isDark ? '#cbd5e1' : '#374151';
      const titleText = isDark ? '#e5e7eb' : '#111827';
      const gridLine = isDark ? 'rgba(255,255,255,0.10)' : '#e5e7eb';
      const tooltipBg = isDark ? '#0b1220' : '#ffffff';

      const option = {
        title: { text: 'è¯·æ±‚è¶‹åŠ¿', left: 'center', textStyle: { color: titleText } },
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'cross' },
          backgroundColor: tooltipBg,
          borderColor: gridLine,
          textStyle: { color: titleText },
          valueFormatter: (value) => Math.floor(value),
          extraCssText: 'border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.25); padding:10px 12px;'
        },
        legend: { data: ['æ€»è¯·æ±‚', 'é”™è¯¯'], bottom: 0, textStyle: { color: axisText } },
        grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
        xAxis: {
          type: 'category',
          data: labels,
          axisLabel: {
            interval: range === '30d' ? 2 : 'auto',
            rotate: range === '24h' ? 45 : 0,
            color: axisText
          },
          axisLine: { lineStyle: { color: gridLine } }
        },
        yAxis: {
          type: 'value',
          minInterval: 1,
          axisLabel: { formatter: (value) => Math.floor(value), color: axisText },
          splitLine: { lineStyle: { color: gridLine } },
          axisLine: { lineStyle: { color: gridLine } },
          axisPointer: { label: { formatter: (params) => Math.floor(params.value) } }
        },
        series: [
          {
            name: 'æ€»è¯·æ±‚',
            type: 'line',
            smooth: true,
            data: reqData,
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: 'rgba(243, 128, 32, 0.4)' },
                { offset: 1, color: 'rgba(243, 128, 32, 0.05)' }
              ])
            },
            itemStyle: { color: '#F38020' }
          },
          {
            name: 'é”™è¯¯',
            type: 'bar',
            data: errData,
            itemStyle: { color: '#ef4444' }
          }
        ]
      };

      chartInstance.setOption(option);
      window.onresize = () => chartInstance.resize();
    }

    init();
  </script>
</body>
</html>
